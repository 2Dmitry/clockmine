## Установка

### 1. git clone
```bash
git clone https://github.com/2Dmitry/clockmine.git
```
```bash
cd clockmine
```
```bash
cp ./deploy/example/.env ./.env
```

### 2. Учетные записи
#### 2.1 Readmine
Копируем API-ключ для вашей учетной записи Redmine и вставляем его значение в переменную `REDMINE_API_KEY` в `.env` файле
- Заходим в [`Моя учётная запись`](https://redmine.sbps.ru/my/account);
- В крайнем правом блоке есть "Ключ доступа к API" -> "Показать".
#### 2.2 Clockify
- Создаем или логинимся (если уже есть) в учетную запись [`Clockify`](https://app.clockify.me/en/login), можно использовать учетную запись Google;
- Переходим в [`настройки`](https://app.clockify.me/user/settings) и скролим в самый низ;
- Генерируем API-ключ в соответствующем поле и копируем его в переменную `CLOCKIFY_API_KEY` в `.env` файле;
- Устанавливаем на свой вкус [`приложение`](https://clockify.me/apps), я использовал расширение для Google Chrome (рекомендую именно расширения для браузеров, т.к. они позволяют нажатием одной кнопки запускать таймер прямо из задачи в Redmine);
- _(по желанию)_ **Если** установили одно из приложений, **то** переходим в настройки этого приложения. Оставляем включенными только одну опцию: "Показывать всплывающее окно"; Что значит опция "Включить контекстное меню" я так и не понял
- _(по желанию)_ Переходим в [`Настройки Clockify`](https://app.clockify.me/workspaces/), затем - в "Настройки" у конкретного "Workspace", затем - во вкладку "Разрешения", затем деактивируем "Активировать оплачиваемые часы".
- **Если** установили одно из приложений, **то** заходим в настройки расширения Clockify для браузера, затем:
  * переходим в "Интеграции";
  * _(по желанию)_ отключаем все интеграции;
  * в поле `Custom domain url` вводим `https://redmine.sbps.ru` - на конце обязательно не должно быть слеша, проверьте;
  * в выпадающем списке выбираем `Redmine`;
  * нажимаем `ADD`;
  * Нажмите `refresh` в установленном приложении и зайдите в любую Redmine-задачу. Вы увидите, что появилась кнопка `Start timer`.
  
### 3. Предварительная настройка Clockmine
- **Если** ваша таймзона отличается от `Europe/Moscow`, **то** в `.env` файле меняем значение переменной `TIMEZONE` на таймзону из списка разрешенных таймзон, перечисленных в файле `timezones.py`;
  * Default: таймзоной по умолчанию выбрана `Europe/Moscow`.
- _(по желанию)_ Можно в .env файле в переменной `REDMINE_URL_TIME_ENTRY` указать любую ссылку, которая будет выводится в консоль сразу после того, как вы успешно выполните команду `push` (о которой мы поговорим чуть позже);
  * Default: в консоль выводится [`такая`](https://redmine.sbps.ru/time_entries?utf8=%E2%9C%93&set_filter=1&sort=spent_on%3Adesc&f%5B%5D=spent_on&op%5Bspent_on%5D=w&f%5B%5D=user_id&op%5Buser_id%5D=%3D&v%5Buser_id%5D%5B%5D=me&f%5B%5D=&c%5B%5D=created_on&c%5B%5D=hours&c%5B%5D=activity&c%5B%5D=user&c%5B%5D=project&c%5B%5D=issue&group_by=spent_on&t%5B%5D=hours&t%5B%5D=) ссылка.
- В переменной `REDMINE_ACTIVITIES_NOT_ALLOWED` указываем в формате python-списка деятельность, которой вы не пользуетесь при проставлении трудочасов;
  * Default: из доступных дейтельностей исключён "Безнес-анализ".

### 4. Полетели
```bash
docker-compose build
```
(если настроены алиасы, то командой `dc build`)
```bash
docker-compose up -d
```
(если настроены алиасы, то командой `dc up -d`)

При первом запуске выполняем команду:
```bash
docker-compose exec app ./manage.py init
```

### 5. Как пользоваться
1. Запускаем таймер:
- **Либо** Открываем задачу в Redmine и нажимаем кнопку "Start timer".
- **Либо** Вводим в Clockify номер Redmine задачи, запускаем таймер.
2. _(по желанию)_ Выбираем тег/деятельность.
3. Останавливаем таймер:
- **Либо** Нажимаем "Стоп" в Clockify
- **Либо** Открываем задачу в Redmine и нажимаем кнопку "Start timer".
- **Либо** Выполняем в терминале либо команду `report` и/или команду `push`
`docker-compose exec app ./manage.py report`
`docker-compose exec app ./manage.py push`

### 6. Правила
1. В описании/заголовке затреканного времени в Clockify обязательно должен быть номер задачи, к которой у вас есть доступ в Redmine.
2. Для успешного выполнения команды `docker-compose exec app ./manage.py push` каждая распаршенная запись из Clockify должна иметь `True` в колонке `Можно затрекать`.
3. **Если** у вас запущен таймер, т.к. вы забыли его остановить, **то** clockmine самостоятельно остановит текущий таймер.
4. **Если** вы не выбрали никакой тег (аналог "Деятельность" в Redmine) в записи Clockify, **то** этой записи будет автоматически присвоен тег/деятельность "Разработка".
5. Время будет затрекано в Redmine в ту дату, в которую был сделан старт таймера в Clockify.
- **Если** вы работали в пятницу и забыли затрекать, **то**, после успешного выполнения команды "push" в понедельник, время будет затрекано в пятницу.
- **Если** вы начали трекать время в 23:30 вторника, а закончили в 1:00 среды, **то** время будет затрекано во вторник.
6. Информация о затреканном времени удаляется из Clockify сразу после того, как была успешно перенесена в Redmine.

### 7. Варианты команд
```
docker-compose exec app ./manage.py init
docker-compose exec app ./manage.py report
docker-compose exec app ./manage.py report --coeff 1.073
docker-compose exec app ./manage.py report --target 5.50
docker-compose exec app ./manage.py push
docker-compose exec app ./manage.py push --coeff 1.073
docker-compose exec app ./manage.py push --target 5.50
```
- введенное вами число пройдет валидацию, если будет больше нуля;
- report - получить информацию о затреканном времени из Clockify;
- push - перенести затреканное время из Clockify в Redmine и удалить всё затреканное время в Clockify;
- coeff - умножает каждое затреканное время на значение coeff, т.е. можно легко затрекать 0.5 времени и не считать самому;
- target - указывает итоговое суммарное значение затреканного времени, т.е. если вы суммарно затрекали 6.0h, но знаете что 30m вы оказывали консультации во многих задачах по чуть-чуть и никак не могли затрекать это время, то указывайте `--target 6.5`.
